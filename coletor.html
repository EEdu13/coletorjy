<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avaliação de Sobrevivência - PWA</title>
    <meta name="theme-color" content="#7CB342" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="ChatGPT Image 19 de set. de 2025, 09_16_46.png" />
    <link rel="apple-touch-icon" href="ChatGPT Image 19 de set. de 2025, 09_16_46.png" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary-green:#7CB342; --dark-green:#689F38; --light-green:#AED581; --brown:#8D6E63; --dark-brown:#5D4037; --white:#fff; --gray:#9E9E9E; --dark-gray:#424242; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--light-green) 0%, var(--primary-green) 100%); min-height: 100vh; color: var(--dark-gray); padding: 20px; }
        .app-header { background: rgba(255,255,255,.95); backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,.1); text-align: center; border: 1px solid rgba(124,179,66,.2) }
        .app-header h1 { color: var(--brown); font-size: 2.2em; font-weight: 700; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,.1) }
        .app-header p { color: var(--gray); font-size: 1em }
        .form-card { background: rgba(255,255,255,.95); backdrop-filter: blur(15px); border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,.1); margin-bottom: 25px; border: 1px solid rgba(124,179,66,.2) }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 20px; margin-bottom: 25px }
        .form-group { display: flex; flex-direction: column }
        .form-group label { font-weight: 600; color: var(--brown); margin-bottom: 8px; font-size: 1.1em }
        .form-group input, .form-group select { padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1em; transition: all .3s ease; background: rgba(255,255,255,.9) }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-green); box-shadow: 0 0 0 3px rgba(124,179,66,.1); transform: translateY(-2px) }
        .mudas-restantes { background: linear-gradient(135deg,var(--primary-green) 0%, var(--dark-green) 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(124,179,66,.3) }
        .mudas-restantes h3 { font-size: 1.4em; margin-bottom: 10px }
        .mudas-restantes-valor { font-size: 2.8em; font-weight: bold }
        .mudas-restantes.alerta { background: linear-gradient(135deg,#FF9800 0%,#F57C00 100%) }
        .mudas-restantes.bloqueado { background: linear-gradient(135deg,#F44336 0%,#D32F2F 100%) }
        .conformidades-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 20px; margin-top: 25px }
        .conformidade-item { background: linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); border-radius: 15px; padding: 20px; border-left: 5px solid var(--primary-green); transition: all .3s ease; box-shadow: 0 4px 15px rgba(0,0,0,.1) }
        .conformidade-item:hover { transform: translateX(5px); box-shadow: 0 8px 25px rgba(0,0,0,.15) }
        .conformidade-item label { font-weight: 600; color: var(--dark-gray); display: block; margin-bottom: 12px; font-size: 1.05em }
        .conformidade-result { display: flex; align-items: center; gap: 12px; margin-top: 10px }
        .counter-container { display: flex; align-items: center; background: white; border: 2px solid #ddd; border-radius: 25px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,.1) }
        .counter-btn { background: var(--primary-green); color: white; border: none; width: 40px; height: 40px; cursor: pointer; font-size: 1.3em; font-weight: bold; transition: all .2s ease; display: flex; align-items: center; justify-content: center }
        .counter-btn:hover { background: var(--dark-green); transform: scale(1.1) }
        .counter-btn.minus { background: var(--brown) }
        .counter-btn.minus:hover { background: var(--dark-brown) }
        .conformidade-result input { width: 70px; padding: 10px 8px; border: none; text-align: center; font-weight: bold; font-size: 1.1em; background: transparent; outline: none }
        .percentage { background: var(--primary-green); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: .95em; min-width: 70px; text-align: center }
        .btn-primary { background: linear-gradient(135deg,var(--primary-green) 0%, var(--dark-green) 100%); color: white; padding: 18px 35px; border: none; border-radius: 25px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all .3s ease; box-shadow: 0 10px 30px rgba(124,179,66,.3); width: 100%; margin-top: 20px; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(124,179,66,.4) }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .falha-total { background: linear-gradient(135deg,var(--brown) 0%, var(--dark-brown) 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-top: 25px; box-shadow: 0 10px 30px rgba(141,110,99,.3) }
        .falha-total h3 { font-size: 1.6em; margin-bottom: 12px }
        .status-indicator { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 0.9em; z-index: 1000; }
        .status-online { background: #e8f5e8; color: var(--primary-green); }
        .status-offline { background: #ffebee; color: #f44336; }
        .status-syncing { background: #fff3e0; color: #f57c00; }
        .status-saved { background: #e3f2fd; color: #1976d2; }
        .success-message { background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); color: var(--primary-green); padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; font-weight: 600; border: 2px solid var(--primary-green); }
        .error-message { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); color: #f44336; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; font-weight: 600; border: 2px solid #f44336; }
        .storage-info { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 15px; border-radius: 12px; text-align: center; margin: 15px 0; font-weight: 500; border: 1px solid #2196f3; font-size: 0.95em; }
        .photo-preview { margin-top: 10px; max-width: 100%; border-radius: 8px; overflow: hidden; border: 2px dashed #ddd; min-height: 120px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; position: relative; }
        .photo-preview img { max-width: 100%; height: auto; border-radius: 6px; }
        .photo-preview.empty { color: #999; font-size: 0.9em; }
        .photo-preview .remove-photo { position: absolute; top: 5px; right: 5px; background: rgba(244, 67, 54, 0.9); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 12px; }
        input[type="file"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; background: white; cursor: pointer; }
        input[type="file"]:focus { border-color: var(--primary-green); outline: none; }
        .photo-loading { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #f57c00; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; border: 2px solid #ff9800; }
        .photo-success { background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); color: var(--primary-green); padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; border: 2px solid var(--primary-green); font-size: 0.9em; margin-top: 5px; }
        .photo-error { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); color: #f44336; padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; border: 2px solid #f44336; font-size: 0.9em; margin-top: 5px; }
        @media (max-width: 768px) { body{padding:15px} .form-grid{grid-template-columns:1fr} .conformidades-grid{grid-template-columns:1fr} .app-header h1{font-size:1.8em} }
    </style>
</head>
<body>
    <div id="statusIndicator" class="status-indicator status-offline">Modo Offline</div>
    
    <div class="app-header">
        <h1>AVALIAÇÃO DE SOBREVIVÊNCIA</h1>
        <p>Controle de Qualidade de Mudas</p>
    </div>

    <div id="messageContainer"></div>

    <div class="form-card">
        <h2 style="color: var(--brown); margin-bottom: 25px; font-size: 1.8em;">📋 Dados da Avaliação</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Fazenda</label>
                <input type="text" id="fazenda" placeholder="Ex: Vale do Rio da Prata" required>
            </div>
            <div class="form-group">
                <label>Talhão</label>
                <input type="text" id="talhao" placeholder="Ex: 76" required>
            </div>
            <div class="form-group">
                <label>Clone</label>
                <input type="text" id="clone" placeholder="Ex: AEC 144" required>
            </div>
            <div class="form-group">
                <label>Data Plantio</label>
                <input type="text" id="dataPlantio" placeholder="dd/mm/aaaa" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" required>
            </div>
            <div class="form-group">
                <label>Data Avaliação</label>
                <input type="text" id="dataAvaliacao" placeholder="dd/mm/aaaa" pattern="\d{2}/\d{2}/\d{4}" maxlength="10" required>
            </div>
            <div class="form-group">
                <label>Idade do Plantio (dias)</label>
                <input type="number" id="idadePlantio" placeholder="Ex: 120" min="0" readonly>
            </div>
            <div class="form-group">
                <label>Dias da Avaliação</label>
                <select id="diasAvaliacao" required>
                    <option value="">Selecione...</option>
                    <option value="15">15 DIAS</option>
                    <option value="30">30 DIAS</option>
                    <option value="60">60 DIAS</option>
                    <option value="90">90 DIAS</option>
                </select>
            </div>
            <div class="form-group">
                <label>Mudas Avaliadas</label>
                <input type="number" id="mudasAvaliadas" placeholder="Ex: 4480" onchange="calcularPercentuais()" min="1" required>
            </div>
            <div class="form-group">
                <label>Área Talhão (ha)</label>
                <input type="number" id="areaTalhao" placeholder="Ex: 24.37" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Área Avaliada (ha)</label>
                <input type="number" id="areaAvaliada" placeholder="Ex: 15.41" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Avaliador</label>
                <input type="text" id="avaliador" placeholder="Ex: Marco Thulio" required>
            </div>
            <div class="form-group">
                <label>Viveiro</label>
                <input type="text" id="viveiro" placeholder="Ex: Santa Isabel" required>
            </div>
            <div class="form-group">
                <label>Status da Carga</label>
                <select id="statusCarga" required>
                    <option value="">Selecione...</option>
                    <option value="Aprovada">Aprovada</option>
                    <option value="Reprovada">Reprovada</option>
                    <option value="Em Análise">Em Análise</option>
                </select>
            </div>
        </div>

        <h3 style="color: var(--brown); margin: 30px 0 20px 0; font-size: 1.5em;">📸 Documentação Fotográfica</h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label>📷 Foto da Área</label>
                <input type="file" id="fotoArea" accept="image/*" capture="environment">
                <div id="previewFotoArea" class="photo-preview"></div>
            </div>
            <div class="form-group">
                <label>📷 Foto da Linha</label>
                <input type="file" id="fotoLinha" accept="image/*" capture="environment">
                <div id="previewFotoLinha" class="photo-preview"></div>
            </div>
        </div>

        <h3 style="color: var(--brown); margin: 30px 0 20px 0; font-size: 1.5em;">Não Conformidades</h3>
        
        <div class="mudas-restantes" id="mudasRestantes">
            <h3>Mudas Restantes para Avaliar</h3>
            <div class="mudas-restantes-valor" id="mudasRestantesValor">4480</div>
        </div>

        <div class="conformidades-grid">
            <div class="conformidade-item">
                <label>QUEBRADAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('quebradas', -1)" type="button">-</button>
                        <input type="number" id="quebradas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('quebradas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualQuebradas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>FORMIGAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('formigas', -1)" type="button">-</button>
                        <input type="number" id="formigas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('formigas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualFormigas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>PISOTEADAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('pisoteadas', -1)" type="button">-</button>
                        <input type="number" id="pisoteadas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('pisoteadas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualPisoteadas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>SEM PLANTAR</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('semPlantar', -1)" type="button">-</button>
                        <input type="number" id="semPlantar" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('semPlantar', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualSemPlantar">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>COLETO AFOGADO</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('coletoAfogado', -1)" type="button">-</button>
                        <input type="number" id="coletoAfogado" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('coletoAfogado', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualColetoAfogado">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>SUBSTRATO EXPOSTO</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('substratoExposto', -1)" type="button">-</button>
                        <input type="number" id="substratoExposto" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('substratoExposto', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualSubstratoExposto">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>QUEIMA ADUBO</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('queimaAdubo', -1)" type="button">-</button>
                        <input type="number" id="queimaAdubo" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('queimaAdubo', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualQueimaAdubo">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>RAIZ PARALISADA</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('raizParalisada', -1)" type="button">-</button>
                        <input type="number" id="raizParalisada" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('raizParalisada', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualRaizParalisada">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>CANELA-PRETA</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('canelaPreta', -1)" type="button">-</button>
                        <input type="number" id="canelaPreta" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('canelaPreta', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualCanelaPreta">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>GAFANHOTOS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('gafanhotos', -1)" type="button">-</button>
                        <input type="number" id="gafanhotos" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('gafanhotos', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualGafanhotos">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>ESCALDADURA</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('escaldadura', -1)" type="button">-</button>
                        <input type="number" id="escaldadura" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('escaldadura', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualEscaldadura">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>OUTROS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('outros', -1)" type="button">-</button>
                        <input type="number" id="outros" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('outros', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualOutros">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>AUSENCIA DE COVA</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('ausenciaDeCova', -1)" type="button">-</button>
                        <input type="number" id="ausenciaDeCova" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('ausenciaDeCova', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualAusenciaDeCova">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>EROSAO</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('erosao', -1)" type="button">-</button>
                        <input type="number" id="erosao" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('erosao', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualErosao">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>PRAGAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('pragas', -1)" type="button">-</button>
                        <input type="number" id="pragas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('pragas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualPragas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>QUEBRADAS VIVAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('quebradasVivas', -1)" type="button">-</button>
                        <input type="number" id="quebradasVivas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('quebradasVivas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualQuebradasVivas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>TOMBADAS VIVAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('tombadasVivas', -1)" type="button">-</button>
                        <input type="number" id="tombadasVivas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('tombadasVivas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualTombadasVivas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>ESCALDADURA VIVAS</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('escaldaduraVivas', -1)" type="button">-</button>
                        <input type="number" id="escaldaduraVivas" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('escaldaduraVivas', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualEscaldaduraVivas">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>FALSA DE SUBSOLAGEM - TOCO</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('falsaSubsolagemToco', -1)" type="button">-</button>
                        <input type="number" id="falsaSubsolagemToco" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('falsaSubsolagemToco', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualFalsaSubsolagemToco">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>QUEIMADA VIVA</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('queimadaViva', -1)" type="button">-</button>
                        <input type="number" id="queimadaViva" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('queimadaViva', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualQueimadaViva">0%</div>
                </div>
            </div>

            <div class="conformidade-item">
                <label>RASPAGEM GRILO - 2° NIVEL</label>
                <div class="conformidade-result">
                    <div class="counter-container">
                        <button class="counter-btn minus" onclick="alterarValor('raspagemGrilo2Nivel', -1)" type="button">-</button>
                        <input type="number" id="raspagemGrilo2Nivel" value="0" onchange="calcularPercentuais()" min="0">
                        <button class="counter-btn" onclick="alterarValor('raspagemGrilo2Nivel', 1)" type="button">+</button>
                    </div>
                    <div class="percentage" id="percentualRaspagemGrilo2Nivel">0%</div>
                </div>
            </div>
        </div>

        <div class="falha-total" id="falhaTotal">
            <h3>Total de Falhas</h3>
            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;" id="totalFalhasValor">0</div>
            <div style="font-size: 1.3em;" id="percentualFalhasValor">0%</div>
        </div>

        <div class="mudas-restantes" id="sobrevivenciaTalhao">
            <h3>SOBREVIVÊNCIA DO TALHÃO</h3>
            <div class="mudas-restantes-valor" id="percentualSobrevivencia">100%</div>
        </div>

        <div id="storageInfo" class="storage-info"></div>

        <button class="btn-primary" onclick="salvarAvaliacao()">Salvar Avaliação</button>
    </div>

    <script>
        // Configurar datas iniciais
        document.getElementById('dataPlantio').value = '13/08/2024';
        document.getElementById('dataAvaliacao').value = '13/09/2025';

        // Função para aplicar máscara de data (dd/mm/aaaa)
        function aplicarMascaraData(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length >= 2) valor = valor.slice(0, 2) + '/' + valor.slice(2);
            if (valor.length >= 5) valor = valor.slice(0, 5) + '/' + valor.slice(5, 9);
            input.value = valor;
        }

        // Função para converter data brasileira (dd/mm/aaaa) para Date
        function converterDataBrasileira(dataBrasil) {
            if (!dataBrasil || dataBrasil.length !== 10) return null;
            const partes = dataBrasil.split('/');
            if (partes.length !== 3) return null;
            const dia = parseInt(partes[0]);
            const mes = parseInt(partes[1]) - 1; // mês em JS é 0-11
            const ano = parseInt(partes[2]);
            return new Date(ano, mes, dia);
        }

        // Função para converter data brasileira (dd/mm/aaaa) para formato ISO (aaaa-mm-dd)
        function converterDataParaISO(dataBrasil) {
            if (!dataBrasil || dataBrasil.length !== 10) return '';
            const partes = dataBrasil.split('/');
            if (partes.length !== 3) return '';
            return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
        }

        // Função para calcular idade do plantio baseado na diferença de datas
        function calcularIdadePlantio() {
            const dataPlantio = document.getElementById('dataPlantio').value;
            const dataAvaliacao = document.getElementById('dataAvaliacao').value;
            
            if (dataPlantio && dataAvaliacao) {
                const plantio = converterDataBrasileira(dataPlantio);
                const avaliacao = converterDataBrasileira(dataAvaliacao);
                
                if (plantio && avaliacao && avaliacao >= plantio) {
                    const diffTime = avaliacao - plantio;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    document.getElementById('idadePlantio').value = diffDays;
                } else {
                    document.getElementById('idadePlantio').value = '';
                }
            } else {
                document.getElementById('idadePlantio').value = '';
            }
        }
        
        // Adicionar listeners para calcular idade do plantio e aplicar máscaras
        document.getElementById('dataPlantio').addEventListener('input', function() {
            aplicarMascaraData(this);
            calcularIdadePlantio();
        });
        document.getElementById('dataAvaliacao').addEventListener('input', function() {
            aplicarMascaraData(this);
            calcularIdadePlantio();
        });

        // Calcular idade inicial
        calcularIdadePlantio();

        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('Service Worker registrado com sucesso:', registration.scope);
                
                // Força atualização quando há novo Service Worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Novo Service Worker instalado, recarrega a página
                            window.location.reload();
                        }
                    });
                });
                
                // Escuta mensagens do Service Worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
                
            }).catch(function(error) {
                console.log('Falha ao registrar Service Worker:', error);
            });
        }

        // Status e conectividade
        let isOnline = false;
        let isSyncing = false;
        // Detecta automaticamente se está em localhost ou produção
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:8000/api' : 
            `${window.location.origin}/api`;
        
        // Verificar conectividade com servidor
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const wasOffline = !isOnline;
                    isOnline = true;
                    
                    // Se estava offline e agora está online, tentar sincronizar automaticamente
                    if (wasOffline && !isSyncing) {
                        await sincronizarAutomaticamente();
                    }
                    
                    return true;
                }
            } catch (error) {
                console.log('Servidor não disponível, mantendo modo offline');
            }
            
            isOnline = false;
            return false;
        }
        
        // Sincronização automática quando ficar online
        async function sincronizarAutomaticamente() {
            const avaliacoesSalvas = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
            
            if (avaliacoesSalvas.length === 0 || isSyncing) {
                return;
            }
            
            isSyncing = true;
            updateStatus();
            
            console.log(`Iniciando sincronização automática de ${avaliacoesSalvas.length} avaliações...`);
            
            let sincronizadas = 0;
            let falhas = 0;
            const avaliacoesRestantes = [];
            
            for (const avaliacao of avaliacoesSalvas) {
                try {
                    const resultado = await enviarParaServidor(avaliacao);
                    if (resultado.success) {
                        sincronizadas++;
                        console.log(`Avaliação ${avaliacao.id} sincronizada com sucesso`);
                    } else {
                        falhas++;
                        avaliacoesRestantes.push(avaliacao);
                        console.warn(`Falha ao sincronizar avaliação ${avaliacao.id}:`, resultado.error);
                    }
                } catch (error) {
                    falhas++;
                    avaliacoesRestantes.push(avaliacao);
                    console.error(`Erro ao sincronizar avaliação ${avaliacao.id}:`, error);
                }
            }
            
            // Atualizar localStorage apenas com as que não foram sincronizadas
            localStorage.setItem('avaliacoes_salvas', JSON.stringify(avaliacoesRestantes));
            
            if (sincronizadas > 0) {
                showMessage('success', `Sincronização automática: ${sincronizadas} avaliações enviadas para o servidor!`);
            }
            
            if (falhas > 0) {
                showMessage('error', `${falhas} avaliações não puderam ser sincronizadas automaticamente. Use sincronização manual.`);
            }
            
            isSyncing = false;
            updateStatus();
            updateStorageInfo();
        }
        
        // Upload das fotos para Azure Blob e manipulação de arquivos
        let fotoAreaUrl = '';
        let fotoLinhaUrl = '';
        
        // Configuração do upload de fotos
        function setupPhotoUpload() {
            const fotoAreaInput = document.getElementById('fotoArea');
            const fotoLinhaInput = document.getElementById('fotoLinha');
            const previewFotoArea = document.getElementById('previewFotoArea');
            const previewFotoLinha = document.getElementById('previewFotoLinha');
            
            // Preview foto área
            fotoAreaInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Mostrar preview local imediatamente
                    previewFotoArea.innerHTML = '<img src="" alt="Preview Foto Área"><button class="remove-photo" onclick="removePhoto(\'area\')">×</button><div id="statusFotoArea"></div>';
                    const img = previewFotoArea.querySelector('img');
                    img.src = URL.createObjectURL(file);
                    
                    // Upload para Azure Blob (quando estiver online)
                    if (isOnline) {
                        const statusDiv = document.getElementById('statusFotoArea');
                        statusDiv.innerHTML = '<div class="photo-loading">📤 Enviando foto da área...</div>';
                        
                        fotoAreaUrl = await uploadPhotoToAzure(file, 'area');
                        
                        if (fotoAreaUrl) {
                            statusDiv.innerHTML = '<div class="photo-success">✅ Foto da área enviada!</div>';
                            setTimeout(() => statusDiv.innerHTML = '', 3000);
                        } else {
                            statusDiv.innerHTML = '<div class="photo-error">❌ Erro ao enviar foto da área</div>';
                        }
                    } else {
                        const statusDiv = document.getElementById('statusFotoArea');
                        statusDiv.innerHTML = '<div class="photo-loading">📱 Foto salva - será enviada quando online</div>';
                    }
                }
            });
            
            // Preview foto linha
            fotoLinhaInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Mostrar preview local imediatamente
                    previewFotoLinha.innerHTML = '<img src="" alt="Preview Foto Linha"><button class="remove-photo" onclick="removePhoto(\'linha\')">×</button><div id="statusFotoLinha"></div>';
                    const img = previewFotoLinha.querySelector('img');
                    img.src = URL.createObjectURL(file);
                    
                    // Upload para Azure Blob (quando estiver online)
                    if (isOnline) {
                        const statusDiv = document.getElementById('statusFotoLinha');
                        statusDiv.innerHTML = '<div class="photo-loading">📤 Enviando foto da linha...</div>';
                        
                        fotoLinhaUrl = await uploadPhotoToAzure(file, 'linha');
                        
                        if (fotoLinhaUrl) {
                            statusDiv.innerHTML = '<div class="photo-success">✅ Foto da linha enviada!</div>';
                            setTimeout(() => statusDiv.innerHTML = '', 3000);
                        } else {
                            statusDiv.innerHTML = '<div class="photo-error">❌ Erro ao enviar foto da linha</div>';
                        }
                    } else {
                        const statusDiv = document.getElementById('statusFotoLinha');
                        statusDiv.innerHTML = '<div class="photo-loading">📱 Foto salva - será enviada quando online</div>';
                    }
                }
            });
            
            // Configurar previews vazios
            previewFotoArea.innerHTML = '<span class="empty">📷 Toque para capturar foto da área</span>';
            previewFotoLinha.innerHTML = '<span class="empty">📷 Toque para capturar foto da linha</span>';
        }
        
        // Função para remover foto
        function removePhoto(tipo) {
            if (tipo === 'area') {
                document.getElementById('fotoArea').value = '';
                document.getElementById('previewFotoArea').innerHTML = '<span class="empty">📷 Toque para capturar foto da área</span>';
                fotoAreaUrl = '';
            } else {
                document.getElementById('fotoLinha').value = '';
                document.getElementById('previewFotoLinha').innerHTML = '<span class="empty">📷 Toque para capturar foto da linha</span>';
                fotoLinhaUrl = '';
            }
        }
        
        // Upload para Azure Blob Storage
        async function uploadPhotoToAzure(file, tipo) {
            try {
                // Criar nome único para o arquivo
                const timestamp = new Date().getTime();
                const filename = `${tipo}_${timestamp}_${file.name}`;
                
                // Criar FormData para envio
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('filename', filename);
                formData.append('tipo', tipo);
                
                // Enviar para endpoint do servidor
                const response = await fetch(`${API_BASE_URL}/upload-photo`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ Foto ${tipo} enviada:`, result.url);
                    return result.url; // URL da Azure Blob
                } else {
                    console.error(`❌ Erro ao enviar foto ${tipo}`);
                    return '';
                }
            } catch (error) {
                console.error(`❌ Erro no upload da foto ${tipo}:`, error);
                return '';
            }
        }
        
        // Sincronização manual
        async function sincronizarManual() {
            const avaliacoesSalvas = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
            
            if (avaliacoesSalvas.length === 0) {
                showMessage('error', 'Nenhuma avaliação pendente para sincronizar.');
                return;
            }
            
            if (!isOnline) {
                showMessage('error', 'Servidor offline. Não é possível sincronizar no momento.');
                return;
            }
            
            if (isSyncing) {
                showMessage('error', 'Sincronização já em andamento. Aguarde...');
                return;
            }
            
            isSyncing = true;
            updateStatus();
            
            const btnSincronizar = document.querySelector('[onclick="sincronizarManual()"]');
            if (btnSincronizar) {
                btnSincronizar.disabled = true;
                btnSincronizar.textContent = 'Sincronizando...';
            }
            
            showMessage('success', `Iniciando sincronização manual de ${avaliacoesSalvas.length} avaliações...`);
            
            let sincronizadas = 0;
            let falhas = 0;
            const avaliacoesRestantes = [];
            
            for (const avaliacao of avaliacoesSalvas) {
                try {
                    const resultado = await enviarParaServidor(avaliacao);
                    if (resultado.success) {
                        sincronizadas++;
                    } else {
                        falhas++;
                        avaliacoesRestantes.push(avaliacao);
                    }
                } catch (error) {
                    falhas++;
                    avaliacoesRestantes.push(avaliacao);
                }
            }
            
            // Atualizar localStorage
            localStorage.setItem('avaliacoes_salvas', JSON.stringify(avaliacoesRestantes));
            
            if (sincronizadas > 0) {
                showMessage('success', `Sincronização concluída: ${sincronizadas} avaliações enviadas para o servidor!`);
            }
            
            if (falhas > 0) {
                showMessage('error', `${falhas} avaliações falharam na sincronização. Tente novamente mais tarde.`);
            }
            
            isSyncing = false;
            updateStatus();
            updateStorageInfo();
            
            if (btnSincronizar) {
                btnSincronizar.disabled = false;
                btnSincronizar.textContent = 'Sincronizar Manualmente';
            }
        }
        
        function updateStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const avaliacoesSalvas = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
            
            if (isSyncing) {
                statusIndicator.className = 'status-indicator status-syncing';
                statusIndicator.textContent = 'Sincronizando...';
            } else if (isOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusIndicator.textContent = 'Online - Conectado';
            } else if (avaliacoesSalvas.length > 0) {
                statusIndicator.className = 'status-indicator status-saved';
                statusIndicator.textContent = `${avaliacoesSalvas.length} avaliações pendentes`;
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusIndicator.textContent = 'Modo Offline';
            }
        }

        // Função para mostrar mensagens
        function showMessage(type, message) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Função para atualizar informações de armazenamento
        function updateStorageInfo() {
            const avaliacoes = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
            const storageInfo = document.getElementById('storageInfo');
            
            if (avaliacoes.length > 0) {
                const ultimaAvaliacao = avaliacoes[avaliacoes.length - 1];
                const dataUltima = new Date(ultimaAvaliacao.data_avaliacao).toLocaleDateString('pt-BR');
                storageInfo.innerHTML = `
                    📁 ${avaliacoes.length} avaliações salvas localmente<br>
                    🕒 Última: ${dataUltima} - ${ultimaAvaliacao.fazenda} (Talhão ${ultimaAvaliacao.talhao})
                `;
                storageInfo.style.display = 'block';
            } else {
                storageInfo.style.display = 'none';
            }
        }

        // Função para alterar valor
        function alterarValor(campo, incremento) {
            const input = document.getElementById(campo);
            let valor = parseInt(input.value) || 0;
            valor = Math.max(0, valor + incremento);
            input.value = valor;
            calcularPercentuais();
        }

        // Função para calcular percentuais
        function calcularPercentuais() {
            const mudasAvaliadas = parseInt(document.getElementById('mudasAvaliadas').value) || 0;
            
            if (mudasAvaliadas === 0) return;

            const campos = [
                'quebradas', 'formigas', 'pisoteadas', 'semPlantar', 'coletoAfogado', 
                'substratoExposto', 'queimaAdubo', 'raizParalisada', 'canelaPreta', 
                'gafanhotos', 'escaldadura', 'outros', 'ausenciaDeCova', 'erosao', 'pragas',
                'quebradasVivas', 'tombadasVivas', 'escaldaduraVivas', 'falsaSubsolagemToco',
                'queimadaViva', 'raspagemGrilo2Nivel'
            ];

            let totalFalhas = 0;

            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    const valor = parseInt(elemento.value) || 0;
                    const percentual = ((valor / mudasAvaliadas) * 100).toFixed(1);
                    const percentualElement = document.getElementById(`percentual${campo.charAt(0).toUpperCase() + campo.slice(1)}`);
                    if (percentualElement) {
                        percentualElement.textContent = `${percentual}%`;
                    }
                    totalFalhas += valor;
                }
            });

            const percentualTotal = ((totalFalhas / mudasAvaliadas) * 100).toFixed(1);
            const percentualSobrevivencia = (100 - percentualTotal).toFixed(1);
            
            document.getElementById('totalFalhasValor').textContent = totalFalhas;
            document.getElementById('percentualFalhasValor').textContent = `${percentualTotal}%`;
            
            // Atualizar sobrevivência do talhão
            document.getElementById('percentualSobrevivencia').textContent = `${percentualSobrevivencia}%`;
            
            // Atualizar mudas restantes
            const mudasRestantes = mudasAvaliadas - totalFalhas;
            const mudasRestantesElement = document.getElementById('mudasRestantes');
            const mudasRestantesValor = document.getElementById('mudasRestantesValor');
            
            mudasRestantesValor.textContent = mudasRestantes;
            
            if (mudasRestantes < 0) {
                mudasRestantesElement.className = 'mudas-restantes bloqueado';
            } else if (mudasRestantes < mudasAvaliadas * 0.1) {
                mudasRestantesElement.className = 'mudas-restantes alerta';
            } else {
                mudasRestantesElement.className = 'mudas-restantes';
            }
        }

        // Função para validar formulário
        function validarFormulario() {
            const requiredFields = ['fazenda', 'talhao', 'clone', 'dataPlantio', 'dataAvaliacao', 
                                   'mudasAvaliadas', 'areaTalhao', 'areaAvaliada', 'avaliador', 'viveiro'];
            
            for (let field of requiredFields) {
                const value = document.getElementById(field).value.trim();
                if (!value) {
                    showMessage('error', `Campo obrigatório: ${field}`);
                    return false;
                }
            }
            
            return true;
        }

        // Função para gerar ID único
        function gerarId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Função para enviar dados para o servidor
        async function enviarParaServidor(avaliacao) {
            try {
                // Mapear campos do formulário para campos do banco
                const dadosServidor = {
                    fazenda: avaliacao.fazenda,
                    talhao: avaliacao.talhao,
                    clone: avaliacao.clone,
                    data_plantio: avaliacao.data_plantio,
                    data_avaliacao: avaliacao.data_avaliacao,
                    dias_avaliacao: avaliacao.dias_avaliacao,
                    idade_plantio: avaliacao.idade_plantio,
                    mudas_avaliadas: avaliacao.mudas_avaliadas,
                    area_talhao: avaliacao.area_talhao,
                    area_avaliada: avaliacao.area_avaliada,
                    avaliador: avaliacao.avaliador,
                    viveiro: avaliacao.viveiro,
                    status_carga: avaliacao.status_carga,
                    quebradas: avaliacao.quebradas,
                    formigas: avaliacao.formigas,
                    pisoteadas: avaliacao.pisoteadas,
                    sem_plantar: avaliacao.sem_plantar,
                    coleto_afogado: avaliacao.coleto_afogado,
                    substrato_exposto: avaliacao.substrato_exposto,
                    queima_adubo: avaliacao.queima_adubo,
                    raiz_paralisada: avaliacao.raiz_paralisada,
                    canela_preta: avaliacao.canela_preta,
                    gafanhotos: avaliacao.gafanhotos,
                    escaldadura: avaliacao.escaldadura,
                    outros: avaliacao.outros,
                    ausencia_de_cova: avaliacao.ausencia_de_cova,
                    erosao: avaliacao.erosao,
                    pragas: avaliacao.pragas,
                    quebradas_vivas: avaliacao.quebradas_vivas,
                    tombadas_vivas: avaliacao.tombadas_vivas,
                    escaldadura_vivas: avaliacao.escaldadura_vivas,
                    falsa_subsolagem_toco: avaliacao.falsa_subsolagem_toco,
                    queimada_viva: avaliacao.queimada_viva,
                    raspagem_grilo_2_nivel: avaliacao.raspagem_grilo_2_nivel
                };
                
                const response = await fetch(`${API_BASE_URL}/avaliacoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosServidor)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return { success: true, data: result };
                } else {
                    const error = await response.json();
                    return { success: false, error: error.message };
                }
                
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Função para salvar avaliação (sempre local primeiro, servidor se disponível)
        async function salvarAvaliacao() {
            if (!validarFormulario()) {
                return;
            }

            const btnSalvar = document.querySelector('.btn-primary');
            btnSalvar.disabled = true;
            btnSalvar.textContent = 'Salvando...';

            const avaliacao = {
                id: gerarId(),
                timestamp: new Date().toISOString(),
                fazenda: document.getElementById('fazenda').value,
                talhao: document.getElementById('talhao').value,
                clone: document.getElementById('clone').value,
                data_plantio: converterDataParaISO(document.getElementById('dataPlantio').value),
                data_avaliacao: converterDataParaISO(document.getElementById('dataAvaliacao').value),
                dias_avaliacao: parseInt(document.getElementById('diasAvaliacao').value) || 0,
                idade_plantio: parseInt(document.getElementById('idadePlantio').value) || 0,
                mudas_avaliadas: parseInt(document.getElementById('mudasAvaliadas').value),
                area_talhao: parseFloat(document.getElementById('areaTalhao').value),
                area_avaliada: parseFloat(document.getElementById('areaAvaliada').value),
                avaliador: document.getElementById('avaliador').value,
                viveiro: document.getElementById('viveiro').value,
                status_carga: document.getElementById('statusCarga').value,
                quebradas: parseInt(document.getElementById('quebradas').value) || 0,
                formigas: parseInt(document.getElementById('formigas').value) || 0,
                pisoteadas: parseInt(document.getElementById('pisoteadas').value) || 0,
                sem_plantar: parseInt(document.getElementById('semPlantar').value) || 0,
                coleto_afogado: parseInt(document.getElementById('coletoAfogado').value) || 0,
                substrato_exposto: parseInt(document.getElementById('substratoExposto').value) || 0,
                queima_adubo: parseInt(document.getElementById('queimaAdubo').value) || 0,
                raiz_paralisada: parseInt(document.getElementById('raizParalisada').value) || 0,
                canela_preta: parseInt(document.getElementById('canelaPreta').value) || 0,
                gafanhotos: parseInt(document.getElementById('gafanhotos').value) || 0,
                escaldadura: parseInt(document.getElementById('escaldadura').value) || 0,
                outros: parseInt(document.getElementById('outros').value) || 0,
                ausencia_de_cova: parseInt(document.getElementById('ausenciaDeCova').value) || 0,
                erosao: parseInt(document.getElementById('erosao').value) || 0,
                pragas: parseInt(document.getElementById('pragas').value) || 0,
                quebradas_vivas: parseInt(document.getElementById('quebradasVivas').value) || 0,
                tombadas_vivas: parseInt(document.getElementById('tombadasVivas').value) || 0,
                escaldadura_vivas: parseInt(document.getElementById('escaldaduraVivas').value) || 0,
                falsa_subsolagem_toco: parseInt(document.getElementById('falsaSubsolagemToco').value) || 0,
                queimada_viva: parseInt(document.getElementById('queimadaViva').value) || 0,
                raspagem_grilo_2_nivel: parseInt(document.getElementById('raspagemGrilo2Nivel').value) || 0,
                foto_area: fotoAreaUrl || '',
                foto_linha: fotoLinhaUrl || ''
            };

            let salvoNoServidor = false;
            let mensagemSucesso = '';

            // Se estiver online, tentar salvar no servidor primeiro
            if (isOnline) {
                btnSalvar.textContent = 'Enviando para servidor...';
                const resultadoServidor = await enviarParaServidor(avaliacao);
                
                if (resultadoServidor.success) {
                    salvoNoServidor = true;
                    mensagemSucesso = 'Avaliação salva no servidor com sucesso!';
                } else {
                    console.warn('Erro no servidor:', resultadoServidor.error);
                    mensagemSucesso = `Servidor com problema. Salvando localmente para sincronizar depois.`;
                }
            } else {
                mensagemSucesso = 'Modo offline. Avaliação salva localmente para sincronização automática.';
            }

            // Sempre salvar localmente se não conseguiu salvar no servidor
            if (!salvoNoServidor) {
                btnSalvar.textContent = 'Salvando localmente...';
                try {
                    const avaliacoes = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
                    avaliacoes.push(avaliacao);
                    localStorage.setItem('avaliacoes_salvas', JSON.stringify(avaliacoes));
                } catch (error) {
                    console.error('Erro ao salvar localmente:', error);
                    showMessage('error', 'Erro ao salvar avaliação. Verifique o espaço disponível no dispositivo.');
                    btnSalvar.disabled = false;
                    btnSalvar.textContent = 'Salvar Avaliação';
                    return;
                }
            }

            showMessage('success', mensagemSucesso);
            
            // Limpar formulário
            resetForm();
            
            // Mostrar mensagem de reset
            setTimeout(() => {
                showMessage('info', 'Formulário limpo! Pronto para nova avaliação.');
            }, 1500);
            
            // Atualizar status
            updateStatus();
            updateStorageInfo();

            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Avaliação';
        }
        // Função para resetar formulário completamente
        function resetForm() {
            // Lista de TODOS os campos para limpar completamente
            const camposTexto = [
                'fazenda', 'talhao', 'clone', 'avaliador', 'viveiro'
            ];
            
            const camposNumero = [
                'mudasAvaliadas', 'areaTalhao', 'areaAvaliada', 'idadePlantio'
            ];

            const camposSelect = [
                'statusCarga', 'diasAvaliacao'
            ];

            // Limpar campos de texto
            camposTexto.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '';
            });

            // Limpar campos numéricos
            camposNumero.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '';
            });

            // Limpar selects (voltar para primeira opção vazia)
            camposSelect.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.selectedIndex = 0;
            });

            // Resetar datas para valores padrão
            document.getElementById('dataPlantio').value = '13/08/2024';
            document.getElementById('dataAvaliacao').value = '13/09/2025';

            // Limpar campos de não conformidades
            const camposConformidade = [
                'quebradas', 'formigas', 'pisoteadas', 'semPlantar', 'coletoAfogado', 
                'substratoExposto', 'queimaAdubo', 'raizParalisada', 'canelaPreta', 
                'gafanhotos', 'escaldadura', 'outros', 'ausenciaDeCova', 'erosao', 'pragas',
                'quebradasVivas', 'tombadasVivas', 'escaldaduraVivas', 'falsaSubsolagemToco',
                'queimadaViva', 'raspagemGrilo2Nivel'
            ];

            camposConformidade.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '0';
            });

            // Limpar campos de resultado/percentual
            const camposResultado = [
                'percentualSobrevivencia', 'percentualMortalidade', 'totalFalhas', 
                'percentualFalhas', 'nota'
            ];

            camposResultado.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '';
            });

            // Recalcular percentuais e idade
            calcularPercentuais();
            calcularIdadePlantio();
            
            // Limpar fotos
            removePhoto('area');
            removePhoto('linha');
            fotoAreaUrl = '';
            fotoLinhaUrl = '';
            
            // Log para debug
            console.log('✅ Formulário resetado completamente - TODOS os campos limpos');
            console.log('Formulário resetado completamente');
        }

        // Função para limpar dados salvos (com confirmação)
        function limparDados() {
            const avaliacoes = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
            
            if (avaliacoes.length === 0) {
                showMessage('error', 'Nenhuma avaliação salva para limpar.');
                return;
            }

            if (confirm(`Tem certeza que deseja limpar ${avaliacoes.length} avaliações salvas? Esta ação não pode ser desfeita.`)) {
                localStorage.removeItem('avaliacoes_salvas');
                showMessage('success', 'Todas as avaliações foram removidas do dispositivo.');
                updateStatus();
                updateStorageInfo();
            }
        }

        // Adicionar botões de gerenciamento
        function adicionarBotoesGerenciamento() {
            const formCard = document.querySelector('.form-card');
            
            // Botão de sincronização manual
            const btnSincronizar = document.createElement('button');
            btnSincronizar.onclick = sincronizarManual;
            btnSincronizar.style.cssText = `
                background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); 
                color: white; 
                padding: 18px 35px; 
                border: none; 
                border-radius: 25px; 
                font-size: 1.1em; 
                font-weight: 600; 
                cursor: pointer; 
                transition: all 0.3s ease; 
                box-shadow: 0 10px 30px rgba(33,150,243,0.3); 
                width: 100%; 
                margin-top: 15px;
            `;
            btnSincronizar.textContent = 'Sincronizar Manualmente';
            
            // Botão de limpar dados
            const btnLimpar = document.createElement('button');
            btnLimpar.onclick = limparDados;
            btnLimpar.style.cssText = `
                background: linear-gradient(135deg, #FF5722 0%, #D84315 100%); 
                color: white; 
                padding: 18px 35px; 
                border: none; 
                border-radius: 25px; 
                font-size: 1.1em; 
                font-weight: 600; 
                cursor: pointer; 
                transition: all 0.3s ease; 
                box-shadow: 0 10px 30px rgba(255,87,34,0.3); 
                width: 100%; 
                margin-top: 15px;
            `;
            btnLimpar.textContent = 'Limpar Dados Locais';
            
            formCard.appendChild(btnSincronizar);
            formCard.appendChild(btnLimpar);
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            calcularPercentuais();
            
            // Verificar conectividade inicial
            await checkServerConnection();
            updateStatus();
            updateStorageInfo();
            adicionarBotoesGerenciamento();
            
            // Verificar conectividade e sincronizar automaticamente a cada 15 segundos
            setInterval(async () => {
                await checkServerConnection();
                updateStatus();
            }, 15000);
            
            // Tentativa de sincronização automática a cada 60 segundos se houver dados pendentes
            setInterval(async () => {
                const avaliacoesPendentes = JSON.parse(localStorage.getItem('avaliacoes_salvas') || '[]');
                if (isOnline && avaliacoesPendentes.length > 0 && !isSyncing) {
                    console.log('Tentativa de sincronização automática programada...');
                    await sincronizarAutomaticamente();
                }
            }, 60000);
        });

        // Auto-save no localStorage a cada mudança (backup de segurança)
        function autoSave() {
            const formData = {
                fazenda: document.getElementById('fazenda').value,
                talhao: document.getElementById('talhao').value,
                clone: document.getElementById('clone').value,
                dataPlantio: document.getElementById('dataPlantio').value,
                dataAvaliacao: document.getElementById('dataAvaliacao').value,
                mudasAvaliadas: document.getElementById('mudasAvaliadas').value,
                areaTalhao: document.getElementById('areaTalhao').value,
                areaAvaliada: document.getElementById('areaAvaliada').value,
                avaliador: document.getElementById('avaliador').value,
                viveiro: document.getElementById('viveiro').value,
                statusCarga: document.getElementById('statusCarga').value
            };
            
            localStorage.setItem('formulario_rascunho', JSON.stringify(formData));
        }

        // Carregar rascunho salvo
        function carregarRascunho() {
            const rascunho = localStorage.getItem('formulario_rascunho');
            if (rascunho) {
                const dados = JSON.parse(rascunho);
                Object.keys(dados).forEach(key => {
                    const elemento = document.getElementById(key);
                    if (elemento && dados[key]) {
                        elemento.value = dados[key];
                    }
                });
            }
        }

        // Adicionar event listeners para auto-save
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', autoSave);
                input.addEventListener('blur', autoSave);
            });
            
            // Carregar rascunho na inicialização
            carregarRascunho();
            
            // Inicializar upload de fotos
            setupPhotoUpload();
            
            // Tornar removePhoto global
            window.removePhoto = removePhoto;
        });
    </script>
</body>
</html>